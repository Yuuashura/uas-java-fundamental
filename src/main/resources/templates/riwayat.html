<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Riwayat Pembelian - Inazuma Market</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #1e1535; background-image: url('https://raw.githubusercontent.com/Yuuashura/assets/refs/heads/main/1362745.png'); background-attachment: fixed; background-size: cover; color: #fff; min-height: 100vh; }
        body::after { content: ''; position: fixed; inset: 0; background: rgba(10, 5, 20, 0.85); z-index: -1; }
        .navbar-glass { background: rgba(30, 20, 60, 0.85); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(162, 155, 254, 0.2); }
        .brand-title { font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 2px; color: #a29bfe; }
        .glass-card { background: rgba(40, 30, 70, 0.7); border: 1px solid rgba(162, 155, 254, 0.2); border-radius: 15px; overflow: hidden; box-shadow: 0 5px 25px rgba(0,0,0,0.4); margin-bottom: 25px; transition: 0.3s; }
        .glass-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(162, 155, 254, 0.2); }
        .list-group-item { background-color: transparent; color: #ccc; border-color: rgba(255, 255, 255, 0.1); }
        .badge-status { min-width: 95px; padding: 6px 10px; border-radius: 50px; font-weight: 600; }
        .bg-pending { background: rgba(255, 193, 7, 0.15); color: #ffca2c; border: 1px solid #ffc107; }
        .bg-paid { background: rgba(13, 202, 240, 0.15); color: #0dcaf0; border: 1px solid #0dcaf0; }
        .bg-sent { background: rgba(13, 110, 253, 0.15); color: #6ea8fe; border: 1px solid #0d6efd; }
        .bg-done { background: rgba(32, 201, 151, 0.15); color: #20c997; border: 1px solid #20c997; }
        .bg-cancel { background: rgba(220, 53, 69, 0.15); color: #ea868f; border: 1px solid #dc3545; }
        .img-item { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; border: 1px solid rgba(162, 155, 254, 0.5); }
        .price-total { color: #fdcb6e; font-family: 'Cinzel', serif; font-weight: 700; font-size: 1.2rem; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark navbar-glass p-3 sticky-top">
    <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="/">
            <i class="bi bi-lightning-charge-fill me-2" style="color: #a29bfe;"></i>
            <span class="brand-title">INAZUMA MARKET</span>
        </a>
        <div class="d-flex align-items-center">
            <a href="/keranjang" class="text-white position-relative me-3 fs-5"><i class="bi bi-cart3"></i></a>
            <div th:if="${user != null}" class="text-white fw-bold ps-3 border-start border-white border-opacity-25">
                <span th:text="${user.namaLengkap}">User</span>
            </div>
            <div th:unless="${user != null}">
                <a href="/login" class="btn btn-sm btn-outline-light rounded-pill px-3">Login</a>
            </div>
        </div>
    </div>
</nav>

<div class="container py-5">
    <h3 class="mb-5 text-center" style="font-family: 'Cinzel'; color: #fdcb6e;">Riwayat Dekrit Pembelian</h3>

    <div th:if="${listTransaksi.isEmpty()}" class="text-center py-5">
        <i class="bi bi-scroll display-1 text-white-50"></i>
        <p class="mt-3 fs-5">Belum ada catatan Dekrit.</p>
        <a href="/" class="btn btn-lg btn-outline-light mt-3">Mulai Berbelanja</a>
    </div>

    <div th:each="trx : ${listTransaksi}" class="glass-card">
        <div class="card-header p-3 d-flex justify-content-between align-items-center" 
             style="background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div>
                <span class="fw-bold me-3" th:text="'ID Transaksi: #' + ${trx.idTransaksi}">#123</span>
                <small class="text-white-50" th:text="${#temporals.format(trx.tanggalTransaksi, 'dd MMMM yyyy HH:mm')}">Tgl</small>
            </div>
            <span th:classappend="'badge badge-status ' + (${trx.status.name() == 'PENDING'} ? 'bg-pending' : (${trx.status.name() == 'PAID'} ? 'bg-paid' : (${trx.status.name() == 'SENT'} ? 'bg-sent' : (${trx.status.name() == 'DONE'} ? 'bg-done' : 'bg-cancel'))))" th:text="${trx.status}">STATUS</span>
        </div>

        <ul class="list-group list-group-flush p-3">
            <li th:each="detail : ${trx.details}" class="list-group-item d-flex align-items-center py-2 px-3">
                <div class="me-3">
                    <img th:if="${detail.gambarSnapshot != null}" th:src="'data:image/jpeg;base64,' + ${detail.gambarSnapshot}" class="img-item">
                    <img th:unless="${detail.gambarSnapshot != null}" th:if="${detail.produk != null}" th:src="'data:image/jpeg;base64,' + ${detail.produk.gambarProduct}" class="img-item">
                    <div th:if="${detail.produk == null and detail.gambarSnapshot == null}" class="img-item bg-dark text-muted d-flex align-items-center justify-content-center" style="font-size: 0.7rem;">DELETED</div>
                </div>
                <div class="flex-grow-1">
                    <div th:if="${detail.namaProductSnapshot != null}" class="fw-bold" th:text="${detail.namaProductSnapshot}">Nama</div>
                    <div th:unless="${detail.namaProductSnapshot != null}" th:if="${detail.produk != null}" class="fw-bold" th:text="${detail.produk.namaProduct}">Nama</div>
                    <div th:if="${detail.produk == null and detail.namaProductSnapshot == null}" class="fw-bold text-danger">Produk Dihapus</div>
                    <small class="text-white-50" th:text="${detail.jumlah} + ' x Rp ' + ${detail.hargaSatuan}">Jml x Harga</small>
                </div>
                <div class="text-end fw-bold text-warning" th:with="subTotal=${detail.jumlah * detail.hargaSatuan}" th:text="'Rp ' + ${subTotal}">Rp 100.000</div>
            </li>
            
            <li class="list-group-item d-flex justify-content-between py-3" style="background: rgba(0,0,0,0.3) !important;">
                <strong style="font-family: 'Cinzel'; color: #fdcb6e;">Total Pembayaran:</strong>
                <span class="price-total" th:text="'Rp ' + ${trx.grandTotal}">Rp 120.000</span>
            </li>
        </ul>

        <div class="card-footer p-3 d-flex justify-content-end gap-2">
            
            <a th:href="@{/transaksi/{id}(id=${trx.idTransaksi})}" class="btn btn-sm btn-outline-light">
                <i class="bi bi-file-earmark-text me-2"></i> Lihat Nota
            </a>

            <div th:if="${trx.status.name() == 'SENT'}">
                <a th:href="@{/riwayat/terima/{id}(id=${trx.idTransaksi})}" 
                   class="btn btn-sm btn-warning fw-bold text-dark"
                   onclick="return confirm('Konfirmasi terima barang?')">
                    <i class="bi bi-check-circle me-2"></i> Terima Pesanan
                </a>
            </div>
        </div>
        
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>